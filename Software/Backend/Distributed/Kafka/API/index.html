

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/images/logo.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/images/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Cian">
  <meta name="keywords" content="software computer programmer otes Cloud personal">
  <meta name="description" content="Kafka API Producer API API生产者流程  Kafka 的 Producer 发送消息采用的是异步发送的方式,在消息发送的过程中,涉及到了两个线程:main 线程和 sender 线程,以及一个线程共享变量: RecordAccumulator main 线程将消息发送给 RecordAccumulator sender 线程不断从 RecordAccumulator 中拉取">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka API">
<meta property="og:url" content="https://softwaremagic.lushan.tech/Software/Backend/Distributed/Kafka/API/">
<meta property="og:site_name" content="SoftwareMagic">
<meta property="og:description" content="Kafka API Producer API API生产者流程  Kafka 的 Producer 发送消息采用的是异步发送的方式,在消息发送的过程中,涉及到了两个线程:main 线程和 sender 线程,以及一个线程共享变量: RecordAccumulator main 线程将消息发送给 RecordAccumulator sender 线程不断从 RecordAccumulator 中拉取">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/LuShan123888/Files/main/Pictures/2021-07-18-19.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LuShan123888/Files/main/Pictures/2021-07-18-20.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LuShan123888/Files/main/Pictures/2021-07-18-21.png">
<meta property="article:published_time" content="2021-12-06T06:10:22.000Z">
<meta property="article:modified_time" content="2021-12-06T06:10:22.000Z">
<meta property="article:author" content="Cian">
<meta property="article:tag" content="software computer programmer otes Cloud personal">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/LuShan123888/Files/main/Pictures/2021-07-18-19.png">
  
  <title>Kafka API - SoftwareMagic</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"softwaremagic.lushan.tech","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/images/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/local-search.xml"};
  </script>
  <script  src="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/js/utils.js" ></script>
  <script  src="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 50vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>SoftwareMagic</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/images/background.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Kafka API">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-12-06 14:10" pubdate>
        2021年12月6日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      14k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      44 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Kafka API</h1>
            
            <div class="markdown-body">
              <h1>Kafka API</h1>
<h2 id="Producer-API">Producer API</h2>
<h3 id="API生产者流程">API生产者流程</h3>
<ul>
<li>Kafka 的 Producer 发送消息采用的是异步发送的方式,在消息发送的过程中,涉及到了两个线程:main 线程和 sender 线程,以及一个线程共享变量: RecordAccumulator</li>
<li>main 线程将消息发送给 RecordAccumulator</li>
<li>sender 线程不断从 RecordAccumulator 中拉取消息发送到 Kafka broker</li>
</ul>
<p><img src="https://raw.githubusercontent.com/LuShan123888/Files/main/Pictures/2021-07-18-19.png" srcset="/images/loading.gif" lazyload alt=""></p>
<ul>
<li><strong>batch.size</strong>:只有数据积累到 batch.size 之后,sender 才会发送数据</li>
<li><strong>linger.time</strong>:如果数据迟迟未达到 batch.size,sender 等待 linger.time 之后就会发送数据</li>
</ul>
<h3 id="异步发送">异步发送</h3>
<h4 id="普通生产者">普通生产者</h4>
<p><strong>pom.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p><strong>实例</strong></p>
<ul>
<li>KafkaProducer:需要创建一个生产者对象,用来发送数据</li>
<li>ProducerConfig:获取所需的一系列配置参数</li>
<li>ProducerRecord:每条数据都要封装成一个 ProducerRecord 对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomProducer</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    Properties props = <span class="hljs-keyword">new</span> Properties();<br>    <span class="hljs-comment">// kafka 集群,broker-list</span><br>    props.put(<span class="hljs-string">&quot;bootstrap.servers&quot;</span>, <span class="hljs-string">&quot;kafka:9092&quot;</span>);<br>    <span class="hljs-comment">//可用ProducerConfig.ACKS_CONFIG 代替 &quot;acks&quot;</span><br>    <span class="hljs-comment">//props.put(ProducerConfig.ACKS_CONFIG, &quot;all&quot;);</span><br>    props.put(<span class="hljs-string">&quot;acks&quot;</span>, <span class="hljs-string">&quot;all&quot;</span>);<br>    <span class="hljs-comment">// 重试次数</span><br>    props.put(<span class="hljs-string">&quot;retries&quot;</span>, <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// 批次大小</span><br>    props.put(<span class="hljs-string">&quot;batch.size&quot;</span>, <span class="hljs-number">16384</span>);<br>    <span class="hljs-comment">// 等待时间</span><br>    props.put(<span class="hljs-string">&quot;linger.ms&quot;</span>, <span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// RecordAccumulator 缓冲区大小</span><br>    props.put(<span class="hljs-string">&quot;buffer.memory&quot;</span>, <span class="hljs-number">33554432</span>);<br>    <span class="hljs-comment">// 序列化配置</span><br>    props.put(<span class="hljs-string">&quot;key.serializer&quot;</span>, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;value.serializer&quot;</span>, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br>    <span class="hljs-comment">// 基于上述配置创建生产者对象</span><br>    Producer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> KafkaProducer&lt;&gt;(props);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>      producer.send(<span class="hljs-keyword">new</span> ProducerRecord&lt;&gt;(<span class="hljs-string">&quot;test-topic&quot;</span>, <span class="hljs-string">&quot;test-&quot;</span> + i, <span class="hljs-string">&quot;test-&quot;</span> + i));<br>    &#125;<br>    producer.close();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="带回调函数的生产者">带回调函数的生产者</h4>
<ul>
<li>回调函数会在 producer 收到 ack 时调用,为异步调用,该方法有两个参数,分别是 RecordMetadata 和 Exception,如果 Exception 为 null,说明消息发送成功,如果Exception 不为 null,说明消息发送失败</li>
<li><strong>注意</strong>:消息发送失败会自动重试,不需要我们在回调函数中手动重试</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CallBackProducer</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    Properties props = <span class="hljs-keyword">new</span> Properties();<br>    props.put(<span class="hljs-string">&quot;bootstrap.servers&quot;</span>, <span class="hljs-string">&quot;kafka:9092&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;acks&quot;</span>, <span class="hljs-string">&quot;all&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;retries&quot;</span>, <span class="hljs-number">1</span>);<br>    props.put(<span class="hljs-string">&quot;batch.size&quot;</span>, <span class="hljs-number">16384</span>);<br>    props.put(<span class="hljs-string">&quot;linger.ms&quot;</span>, <span class="hljs-number">1</span>);<br>    props.put(<span class="hljs-string">&quot;buffer.memory&quot;</span>, <span class="hljs-number">33554432</span>);<br>    props.put(<span class="hljs-string">&quot;key.serializer&quot;</span>,<span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;value.serializer&quot;</span>,<span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br>    Producer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> KafkaProducer&lt;&gt;(props);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>      producer.send(<span class="hljs-keyword">new</span> ProducerRecord&lt;String, String&gt;(<span class="hljs-string">&quot;test-topic&quot;</span>,<span class="hljs-string">&quot;test-&quot;</span> + i, <span class="hljs-keyword">new</span> Callback() &#123;<br>        <span class="hljs-comment">//回调函数,该方法会在 Producer 收到 ack 时调用,为异步调用</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompletion</span><span class="hljs-params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;<br>          <span class="hljs-keyword">if</span> (exception == <span class="hljs-keyword">null</span>) &#123;<br>            System.out.println(metadata.partition() + <span class="hljs-string">&quot; - &quot;</span> + metadata.offset());<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            exception.printStackTrace();<br>          &#125;<br>        &#125;<br>      &#125;);<br>    &#125;<br>    producer.close();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>ProducerRecord类有许多构造函数,其中一个参数partition可指定分区</li>
</ul>
<p><img src="https://raw.githubusercontent.com/LuShan123888/Files/main/Pictures/2021-07-18-20.png" srcset="/images/loading.gif" lazyload alt=""></p>
<h4 id="自定义分区器">自定义分区器</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPartitioner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Partitioner</span> </span>&#123;<br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;<br>    <span class="hljs-comment">// TODO Auto-generated method stub</span><br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">partition</span><span class="hljs-params">(String topic, Object key, <span class="hljs-keyword">byte</span>[] keyBytes, Object value, <span class="hljs-keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;<br>    <span class="hljs-comment">// TODO Auto-generated method stub</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// TODO Auto-generated method stub</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>具体内容填写可参考默认分区器<code>org.apache.kafka.clients.producer.internals.DefaultPartitioner</code></li>
<li>然后Producer配置中注册使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Properties props = <span class="hljs-keyword">new</span> Properties();<br>props.put(ProducerConfig.PARTITIONER_CLASS_CONFIG, MyPartitioner.class);<br>Producer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> KafkaProducer&lt;&gt;(props);<br></code></pre></td></tr></table></figure>
<h3 id="同步发送">同步发送</h3>
<ul>
<li>同步发送的意思就是,一条消息发送之后,会阻塞当前线程,直至返回 ack</li>
<li>由于 send 方法返回的是一个 Future 对象,根据 Futrue 对象的特点,我们也可以实现同步发送的效果,只需在调用 Future 对象的 get 方法即可</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Producer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> KafkaProducer&lt;&gt;(props);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>  producer.send(<span class="hljs-keyword">new</span> ProducerRecord&lt;String, String&gt;(<span class="hljs-string">&quot;test&quot;</span>,  <span class="hljs-string">&quot;test - &quot;</span> + i), <span class="hljs-keyword">new</span> Callback() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompletion</span><span class="hljs-params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;<br>      ...<br>    &#125;<br>  &#125;).get();<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="Consumer-API">Consumer API</h2>
<h3 id="普通消费者">普通消费者</h3>
<ul>
<li><strong>KafkaConsumer</strong>:需要创建一个消费者对象,用来消费数据</li>
<li><strong>ConsumerConfig</strong>:获取所需的一系列配置参数</li>
<li><strong>ConsuemrRecord</strong>:每条数据都要封装成一个 ConsumerRecord 对象</li>
<li>为了使我们能够专注于自己的业务逻辑,Kafka 提供了自动提交 offset 的功能,自动提交 offset 的相关参数:
<ul>
<li><strong>enable.auto.commit</strong>:是否开启自动提交 offset 功能</li>
<li><strong><a target="_blank" rel="noopener" href="http://auto.commit.interval.ms">auto.commit.interval.ms</a></strong>:自动提交 offset 的时间间隔</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomConsumer</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    Properties props = <span class="hljs-keyword">new</span> Properties();<br>    props.put(<span class="hljs-string">&quot;bootstrap.servers&quot;</span>, <span class="hljs-string">&quot;kafka:9092&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;group.id&quot;</span>, <span class="hljs-string">&quot;test-group&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;enable.auto.commit&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;auto.commit.interval.ms&quot;</span>, <span class="hljs-string">&quot;1000&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;key.deserializer&quot;</span>, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;value.deserializer&quot;</span>, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);<br>    KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> KafkaConsumer&lt;&gt;(props);<br>    <span class="hljs-comment">// 订阅主题 test-topic</span><br>    consumer.subscribe(Collections.singletonList(<span class="hljs-string">&quot;test-topic&quot;</span>));<br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>      ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="hljs-number">100</span>);<br>      <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>        System.out.printf(<span class="hljs-string">&quot;offset = %d, key = %s, value = %s%n&quot;</span>, record.offset(), record.key(), record.value());<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="消费者重置offset">消费者重置offset</h3>
<ul>
<li>由于 consumer 在消费过程中可能会出现断电宕机等故障,consumer 恢复后,需要从故障前的位置的继续消费,所以consumer 需要实时记录自己消费到了哪个 offset,以便故障恢复后继续消费</li>
<li>当消费者切换消费者组或数据过期失效的情况下,offset会找不到,此时可以选择不同 的策略重新定位offset</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String AUTO_OFFSET_RESET_CONFIG = <span class="hljs-string">&quot;auto.offset.reset&quot;</span>;<br>Properties props = <span class="hljs-keyword">new</span> Properties();<br>props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="hljs-string">&quot;earliest&quot;</span>);<br>KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> KafkaConsumer&lt;&gt;(props);<br></code></pre></td></tr></table></figure>
<ul>
<li><code>props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;earliest&quot;);</code>与命令行中的<code>--from-beginning</code>拥有相同的作用</li>
</ul>
<blockquote>
<p><strong>auto.offset.reset</strong></p>
<p>What to do when there is no initial offset in Kafka or if the current offset does not exist any more on the server (e.g. because that data has been deleted):</p>
<ul>
<li><strong>earliest</strong>: automatically reset the offset to the earliest offset</li>
<li><strong>latest</strong>: automatically reset the offset to the latest offset</li>
<li><strong>none</strong>: throw exception to the consumer if no previous offset is found for the consumer’s group</li>
<li><strong>anything else</strong>: throw exception to the consumer.</li>
</ul>
<p><strong>TYPE</strong>:string</p>
<p><strong>DEFAULT</strong>:latest</p>
<p><strong>VALID VALUES</strong>:[latest, earliest, none]</p>
</blockquote>
<h3 id="消费者保存offset">消费者保存offset</h3>
<h4 id="自动提交offset">自动提交offset</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 是否自动提交 offset</span><br>props.put(<span class="hljs-string">&quot;enable.auto.commit&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>);<br><span class="hljs-comment">// 自动提交 offset 的时间间隔</span><br>props.put(<span class="hljs-string">&quot;auto.commit.interval.ms&quot;</span>, <span class="hljs-string">&quot;1000&quot;</span>);<br></code></pre></td></tr></table></figure>
<h4 id="手动提交offset">手动提交offset</h4>
<ul>
<li>虽然自动提交 offset 十分便利,但由于其是基于时间提交的,开发人员难以把握offset 提交的时机,因此 <strong>Kafka 还提供了手动提交 offset 的 API</strong></li>
<li>手动提交 offset 的方法有两种
<ol>
<li>commitSync(同步提交)</li>
<li>commitAsync(异步提交)</li>
</ol>
</li>
<li><strong>相同点</strong>:都会将本次 poll 的一批数据最高的 offset 提交</li>
<li><strong>不同点</strong>:commitSync 阻塞当前线程,一直到提交成功,并且会自动失败重试(由不可控因素导致,也会出现提交失败),而 commitAsync 则没有失败重试机制,故有可能提交失败</li>
</ul>
<h5 id="同步提交offset">同步提交offset</h5>
<ul>
<li>由于同步提交 offset 有失败重试机制,故更加可靠</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SyncCommitOffset</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    Properties props = <span class="hljs-keyword">new</span> Properties();<br>    <span class="hljs-comment">//关闭自动提交 offset</span><br>    props.put(<span class="hljs-string">&quot;enable.auto.commit&quot;</span>, <span class="hljs-string">&quot;false&quot;</span>);<br>    KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> KafkaConsumer&lt;&gt;(props);<br>    consumer.subscribe(Collections.singletonList(<span class="hljs-string">&quot;test-topic&quot;</span>));<br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>      <span class="hljs-comment">//消费者拉取数据</span><br>      ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="hljs-number">100</span>);<br>      <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>        System.out.printf(<span class="hljs-string">&quot;offset = %d, key = %s, value= %s%n&quot;</span>, record.offset(), record.key(), record.value());<br>      &#125;<br>      <span class="hljs-comment">//同步提交,当前线程会阻塞直到 offset 提交成功</span><br>      consumer.commitSync();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="异步提交offset">异步提交offset</h5>
<ul>
<li>虽然同步提交 offset 更可靠一些,但是由于其会阻塞当前线程,直到提交成功,因此吞吐量会收到很大的影响,因此更多的情况下,会选用异步提交 offset 的方式</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncCommitOffset</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    Properties props = <span class="hljs-keyword">new</span> Properties();<br>    <span class="hljs-comment">//关闭自动提交</span><br>    props.put(<span class="hljs-string">&quot;enable.auto.commit&quot;</span>, <span class="hljs-string">&quot;false&quot;</span>);<br>    KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> KafkaConsumer&lt;&gt;(props);<br>    consumer.subscribe(Collections.singletonList(<span class="hljs-string">&quot;test-topic&quot;</span>));<br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>      ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="hljs-number">100</span>);<br>      <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>        System.out.printf(<span class="hljs-string">&quot;offset = %d, key = %s, value = %s%n&quot;</span>, record.offset(), record.key(), record.value());<br>      &#125;<br>      <span class="hljs-comment">// 异步提交</span><br>      consumer.commitAsync(<span class="hljs-keyword">new</span> OffsetCommitCallback() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onComplete</span><span class="hljs-params">(Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets, Exception exception)</span> </span>&#123;<br>          <span class="hljs-keyword">if</span> (exception != <span class="hljs-keyword">null</span>) &#123;<br>            System.err.println(<span class="hljs-string">&quot;Commit failed for&quot;</span> + offsets);<br>          &#125;<br>        &#125;<br>      &#125;);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="数据漏消费和重复消费分析">数据漏消费和重复消费分析</h4>
<ul>
<li>无论是同步提交还是异步提交 offset,都有可能会造成数据的漏消费或者重复消费,先提交 offset 后消费,有可能造成数据的漏消费,而先消费后提交 offset,有可能会造成数据的重复消费</li>
</ul>
<h4 id="自定义存储-offset">自定义存储 offset</h4>
<ul>
<li>Kafka 0.9 版本之前,offset 存储在 zookeeper,0.9 版本及之后,默认将 offset 存储在 Kafka的一个内置的 topic 中,除此之外,Kafka 还可以选择自定义存储 offset</li>
<li>offset 的维护是相当繁琐的,因为需要考虑到消费者的 Rebalace
<ul>
<li>当有新的消费者加入消费者组,已有的消费者推出消费者组或者所订阅的主题的分区发生变化,就会触发到分区的重新分配,重新分配的过程叫做 Rebalance</li>
<li>消费者发生 Rebalance 之后,每个消费者消费的分区就会发生变化,因此消费者要首先获取到自己被重新分配到的分区,并且定位到每个分区最近提交的 offset 位置继续消费</li>
</ul>
</li>
<li>要实现自定义存储 offset,需要借助 <code>ConsumerRebalanceListener</code>,以下为示例代码,其中提交和获取 offset 的方法,需要根据所选的 offset 存储系统自行实现,(可将offset存入MySQL数据库)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomSaveOffset</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;TopicPartition, Long&gt; currentOffset = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    Properties props = <span class="hljs-keyword">new</span> Properties();<br>    <span class="hljs-comment">// 关闭自动提交 offset</span><br>    props.put(<span class="hljs-string">&quot;enable.auto.commit&quot;</span>, <span class="hljs-string">&quot;false&quot;</span>);<br>    <span class="hljs-comment">// 创建一个消费者</span><br>    KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> KafkaConsumer&lt;&gt;(props);<br>    <span class="hljs-comment">// 消费者订阅主题</span><br>    consumer.subscribe(Arrays.asList(<span class="hljs-string">&quot;first&quot;</span>),  <span class="hljs-keyword">new</span> ConsumerRebalanceListener() &#123;<br>      <span class="hljs-comment">// 该方法会在 Rebalance 之前调用</span><br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsRevoked</span><span class="hljs-params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;<br>        commitOffset(currentOffset);<br>      &#125;<br><br>      <span class="hljs-comment">// 该方法会在 Rebalance 之后调用</span><br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsAssigned</span><span class="hljs-params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;<br>        currentOffset.clear();<br>        <span class="hljs-keyword">for</span> (TopicPartition partition : partitions) &#123;<br>          consumer.seek(partition, getOffset(partition));<span class="hljs-comment">// 定位到最近提交的 offset 位置继续消费</span><br>        &#125;<br>      &#125;<br>    &#125;);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>      ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="hljs-number">100</span>);<span class="hljs-comment">// 消费者拉取数据</span><br>      <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>        System.out.printf(<span class="hljs-string">&quot;offset = %d, key = %s, value = %s%n&quot;</span>, record.offset(), record.key(), record.value());<br>        currentOffset.put(<span class="hljs-keyword">new</span> TopicPartition(record.topic(), record.partition()), record.offset());<br>      &#125;<br>      commitOffset(currentOffset);<span class="hljs-comment">// 异步提交</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 获取某分区的最新 offset</span><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getOffset</span><span class="hljs-params">(TopicPartition partition)</span> </span>&#123;<br>    <span class="hljs-comment">// TODO</span><br>  &#125;<br><br>  <span class="hljs-comment">// 提交该消费者所有分区的 offset</span><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commitOffset</span><span class="hljs-params">(Map&lt;TopicPartition, Long&gt; currentOffset)</span> </span>&#123;<br>    <span class="hljs-comment">// TODO</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="自定义拦截器">自定义拦截器</h2>
<h3 id="拦截器原理">拦截器原理</h3>
<ul>
<li>
<p>Producer 拦截器(interceptor)是在 Kafka 0.10 版本被引入的,主要用于实现 clients 端的定制化控制逻辑</p>
</li>
<li>
<p>对于 producer 而言,interceptor 使得用户在消息发送前以及 producer 回调逻辑前有机会对消息做一些定制化需求,比如<code>修改消息</code>等,同时,producer 允许用户指定多个 interceptor按序作用于同一条消息从而形成一个拦截链(interceptor chain)</p>
</li>
<li>
<p>Intercetpor 的实现接口是<code>org.apache.kafka.clients.producer.ProducerInterceptor</code>,其定义的方法包括</p>
<ul>
<li>
<p><code>configure(configs)</code>:获取配置信息和初始化数据时调用</p>
</li>
<li>
<p><code>onSend(ProducerRecord)</code>:该方法封装进 KafkaProducer.send 方法中,即它运行在用户主线程中,Producer 确保<strong>在消息被序列化以及计算分区前</strong>调用该方法,用户可以在该方法中对消息做任何操作,但最好保证不要修改消息所属的 topic 和分区,否则会影响目标分区的计算</p>
</li>
<li>
<p><code>onAcknowledgement(RecordMetadata, Exception)</code>:该方法会在消息从 RecordAccumulator 成功发送到 Kafka Broker 之后,或者在发送过程中失败时调用,并且通常都是在 producer 回调逻辑触发之前,onAcknowledgement 运行在producer 的 IO 线程中,因此不要在该方法中放入很重的逻辑,否则会拖慢 producer 的消息发送效率</p>
</li>
<li>
<p><code>close()</code>:关闭 interceptor,主要用于执行一些<strong>资源清理</strong>工作</p>
</li>
<li>
<p>如前所述,interceptor 可能被运行在多个线程中,因此在具体实现时用户需要自行确保线程安全,另外<strong>倘若指定了多个 interceptor,则 producer 将按照指定顺序调用它们</strong>,并仅仅是捕获每个 interceptor 可能抛出的异常记录到错误日志中而非在向上传递,这在使用过程中要特别留意</p>
</li>
</ul>
</li>
</ul>
<h3 id="实例">实例</h3>
<ul>
<li>实现一个简单的双 interceptor 组成的拦截链</li>
<li>第一个 interceptor 会在消息发送前将时间戳信息加到消息 value 的最前部</li>
<li>第二个 interceptor 会在消息发送后更新成功发送消息数或失败发送消息数</li>
</ul>
<h4 id="增加时间戳拦截器">增加时间戳拦截器</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProducerInterceptor</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">String</span>&gt; </span>&#123;<br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerRecord&lt;String, String&gt; <span class="hljs-title">onSend</span><span class="hljs-params">(ProducerRecord&lt;String, String&gt; record)</span> </span>&#123;<br>    <span class="hljs-comment">// 创建一个新的 record,把时间戳写入消息体的最前部</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ProducerRecord(record.topic(), record.partition(), record.timestamp(), record.key(), <span class="hljs-string">&quot;TimeInterceptor: &quot;</span> + System.currentTimeMillis() + <span class="hljs-string">&quot;,&quot;</span> + record.value().toString());<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> </span>&#123;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAcknowledgement</span><span class="hljs-params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;<br>    <span class="hljs-comment">// TODO Auto-generated method stub</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="增加消息统计拦截器">增加消息统计拦截器</h4>
<ul>
<li>统计发送消息成功和发送失败消息数,并在 producer 关闭时打印这两个计数器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProducerInterceptor</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">String</span>&gt;</span>&#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> errorCounter = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> successCounter = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;<br>    <span class="hljs-comment">// TODO Auto-generated method stub</span><br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerRecord&lt;String, String&gt; <span class="hljs-title">onSend</span><span class="hljs-params">(ProducerRecord&lt;String, String&gt; record)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> record;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAcknowledgement</span><span class="hljs-params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;<br>    <span class="hljs-comment">// 统计成功和失败的次数</span><br>    <span class="hljs-keyword">if</span> (exception == <span class="hljs-keyword">null</span>) &#123;<br>      successCounter++;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      errorCounter++;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// 保存结果</span><br>    System.out.println(<span class="hljs-string">&quot;Successful sent: &quot;</span> + successCounter);<br>    System.out.println(<span class="hljs-string">&quot;Failed sent: &quot;</span> + errorCounter);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="producer-主程序">producer 主程序</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InterceptorProducer</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    Properties props = <span class="hljs-keyword">new</span> Properties();<br>    props.put(<span class="hljs-string">&quot;bootstrap.servers&quot;</span>, <span class="hljs-string">&quot;kafka:9092&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;acks&quot;</span>, <span class="hljs-string">&quot;all&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;retries&quot;</span>, <span class="hljs-number">3</span>);<br>    props.put(<span class="hljs-string">&quot;batch.size&quot;</span>, <span class="hljs-number">16384</span>);<br>    props.put(<span class="hljs-string">&quot;linger.ms&quot;</span>, <span class="hljs-number">1</span>);<br>    props.put(<span class="hljs-string">&quot;buffer.memory&quot;</span>, <span class="hljs-number">33554432</span>);<br>    props.put(<span class="hljs-string">&quot;key.serializer&quot;</span>, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br>    props.put(<span class="hljs-string">&quot;value.serializer&quot;</span>, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br>    <span class="hljs-comment">// 构建拦截链</span><br>    List&lt;String&gt; interceptors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    interceptors.add(<span class="hljs-string">&quot;com.lun.kafka.interceptor.TimeInterceptor&quot;</span>);<br>    interceptors.add(<span class="hljs-string">&quot;com.lun.kafka.interceptor.CounterInterceptor&quot;</span>);<br>    props.put(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG, interceptors);<br><br>    Producer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> KafkaProducer&lt;&gt;(props);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>      ProducerRecord&lt;String, String&gt; record = <span class="hljs-keyword">new</span> ProducerRecord&lt;&gt;(<span class="hljs-string">&quot;test-topic&quot;</span>, <span class="hljs-string">&quot;message&quot;</span> + i);<br>      producer.send(record);<br>    &#125;<br>    producer.close();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<p><img src="https://raw.githubusercontent.com/LuShan123888/Files/main/Pictures/2021-07-18-21.png" srcset="/images/loading.gif" lazyload alt=""></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Software/">Software</a>
                    
                      <a class="hover-with-bg" href="/categories/Software/Backend/">Backend</a>
                    
                      <a class="hover-with-bg" href="/categories/Software/Backend/Distributed/">Distributed</a>
                    
                      <a class="hover-with-bg" href="/categories/Software/Backend/Distributed/Kafka/">Kafka</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/Software/Backend/Distributed/ZooKeeper/Curator/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ZooKeeper Curator</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/Software/Backend/Database/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93/DCL/%E7%94%A8%E6%88%B7%E4%B8%8E%E6%9D%83%E9%99%90/">
                        <span class="hidden-mobile">SQL 用户与权限</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                

              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
    
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/js/events.js" ></script>
<script  src="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/js/local-search.js" ></script>



  
    <script  src="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>









  <script  src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>







<!-- 主题的启动项 保持在最底部 -->
<script  src="https://cdn.jsdelivr.net/gh/LuShan123888/SoftwareMagic@gh-pages/js/boot.js" ></script>


</body>
</html>
