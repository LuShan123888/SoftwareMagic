---
title: JD 实习记录
categories:
- Software
- Concept
---
# JD 实习记录

## 业务需求

### 根据仓库权限过滤查询数据

- JWMS管理端的所有查询接口与用户的权限无关,普通用户可查询到不属于他角色权限的记录
- 需要根据当前登录用户的角色权限,过滤掉没有对应权限的查询记录
- 由于需要修改的接口较多,所以通过无侵入的方式对已有接口做增强,使用注解加AOP的方式自动将当前的用户的权限列表转换为查询条件,并注入到查询对象中,然后在Mybatis拦截器中通过MetaObject得到对应的SQL语句,将查询条件拼接到待执行的SQL语句中
- 最终避免了大量的代码修改,也预留了注解提供给后续的开发任务

### 盘点模块与WCS交互

- 盘点模块需要与WCS(仓储自动设备控制系统)交互,扩展盘点模块的使用范围
- 将属于自动设备储区的盘点任务下发至wcs,并且接收wcs回传的盘点结果
- 在原有流程上将属于自动设备的盘点单分离,并根据不同的设备类别,下发给不同的自动设备,并提供统一的对外接口,WCS随后回传盘点结果,并同步盘点单记录和库存,如果有差异,则生成差异记录
- 实现了通过自动设备执行盘点任务,以及JWMS与WCS盘点单与库存的同步

## 项目管理

### 开发流程

1. 了解需求，系统方案设计，排期。
2. master分支中拉取创建自己的开发分支（如：v_fearure_lushan)。
3. 在v_feature_lushan分支上开发，并自测。
4. Code review。
    1. 发送 review 报告邮件。
    2. 根据 review 建议修改代码。
5. 将v_feature_lushan分支合并到v_test。
6. 通过JDOS部署测试环境。
7. 与前端联调。
8. 提测。
    1. 发送提测邮件。
    2. 协助测试处理BUG和问题。
    3. 收到测试报告。
9. 将v_feature_lushan合并到v_gary。
10. 通过J-ONE部署到预发布环境。
11. UAT验证。
    1. 解决UAT验证中遇到的问题
12. 将v_feature_lushan修改合并到master（临上线前1-2天，看情况，沟通好）。
13. 正式发布上线
14. 线上验证（凌晨）

### 行云

1. 工时填报应在对应的项目和任务下进行，不可和其他项目、其他任务混填。
2. 任务的安排周期不能超过3天，若超过，则需要进行合理分解，划分出多个更短的任务周期安排。
3. 每天的工时应按实际的工作情况进行填报，填报方式选则按天填报。
4. 每个任务的工时填报需建立卡片，卡片上应详细注明当天的工时利用情况，不可笼统地写为“研发、维护等简略词语“。
5. 需求分析、系统设计、代码编写、自测、提测、代码审核、预发布和上线等工作内容都可以录入在行云卡片中。
6. 按天填报的工作总结内容可以简略填写，但不能简单地写为“开发了xxx功能”，而是应该大致说明当天工作内容和任务进度，能够让项目组成员了解自己的任务实施情况。
7. 对于当天相同的工作内容，工时信息不要重复填写。对于不同的工作内容，工时信息不要混写。
8. 卡片可以自行建立，但是需要和相应负责人商讨

## 技术要点

### JSF

- **RPC框架**：轻量级，更佳的性能，兼容旧版本协议
- **注册中心**：基于DB作为数据源，前置Index服务；支持十倍接入量；部分逻辑放在注册中心减少客户端负担
- **监控中心**：监控Proxy服务+InfluxDB（2015后改为ElasticSearch）
- **管理端**：基于DB，功能更强大，提供完善的服务治理管理功能；打通京东应用管理平台，提供应用依赖关系梳理
- **HTTP网关**：基于Netty，支持跨语言调用
- **优化与特点**
    - 引入Index服务概念：该服务就是一个最简单HTTP的服务，用于找注册中心节点（同机房或者压力最小或者其它特定场景），可以认为是不会挂的服务，RPC框架会优先连该服务拿注册中心地址，这样子的好处是注册中心地址变化后，RPC框架不用修改任何设置
    - 注册中心内存有服务列表全量缓存，连不上数据库也保证可读
    - 数据库的数据结构更适合各种维度展示、过滤、分析等，例如根据分组/IP/应用/机房等不同维度
    - 注册中心就是个JSF服务，监控到压力大即可进行动态水平扩展，不会出现2015年双十一那样的事故了
    - 服务列表推送逻辑改进：例如原来100个Provider，现在加1个节点，之前的SAF是需要下发101个节点，自己判断加了哪个节点，进行长链接建立；现在的改进是：修改为下发一个add事件，告知RPC框架加了1个节点，RPC框架进行长链接建立；这样做大大减少了推送的数据量
    - 注册中心与RPC框架可各种交互：注册中心和RPC框架是长链接，而且JSF是支持Callback的，注册中心可以调用RPC框架进行服务列表变化之外的操作；例如查看状态，查看配置，配置下发等。

### JDOS

- JDOS是基于open stack的云服务平台，包括以下使用流程：创建系统、创建应用、编译打包、构建镜像、创建分组、创建负载均衡、集群上线、更新集群、调整集群副本数、集群下线。
- 部署项目时,首先将修改合并到指定分支,然后使用JDOS管理平台可以使用该分支的最新提交记录构建镜像,再通过镜像启动容器,部署在服务器上。
- 解决线上问题时,可以通过JDOS提供的容器日志服务查看日志并定位问题。

### 统一接口调用

- **反射调用接口**：设置统一的对外接口，通过入参数指定被调用的接口方法，反射调用接口,将与业务无关的逻辑(如入参校验等)从service层分离,由统一的controller复用并管理,体现了**单一职责原则**。
- **幂等性**：上游请求携带uuid，我们为请求加锁，并缓存同一请求的返回数据，实现高并发下的节流和接口的幂等性。
- **对外接口管理**
    - 通过添加一层接口管理服务,将调用对外接口的实现与业务代码分离，降低系统耦合度。
    - 通过后台管理系统可以配置对应对外接口调用的实现,例如调用域名，是否为异步调用，是否启用，是否可重置等等。
- **异常中心**：可以记录并查看调用对外接口失败时的报文和详细信息。

### 异步队列调用接口

- 需要调用方法时将方法名和入参存入Redis的List中
- 之后有序统一地消费List集合,调用对应的方法
- 实现高并发下的削峰
